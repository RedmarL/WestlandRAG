<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>WestlandRAG Chat</title>
  <style>
    body { font-family: sans-serif; background: #f8f8f8; padding: 20px; }
    #chatbox { width: 100%; height: 320px; background: #fff; padding: 12px; margin-bottom: 10px; overflow-y: auto; border-radius: 8px; border: 1px solid #ccc;}
    #vraag { width: 80%; font-size: 1em; }
    #send { font-size: 1em; }
    .antwoord { margin-bottom: 1.3em; }
    .bronnenbox { background: #f2f6fa; border-radius: 6px; padding: 8px 14px; margin-top: 8px; border-left: 4px solid #6495ed; font-size: 0.96em;}
    .ai-label { color: #0070c9; }
    .user-label { color: #777; }
    .snippet-main { font-size: 1.13em; font-weight: 500; margin-bottom: 0.25em; }
    .bijzin { font-size: 0.98em; color: #555; margin-bottom: 0.10em; }
    .toelichtingbox { font-size: 0.92em; color: #60789c; margin-top: 0.6em; border-left: 2px solid #a8c5ea; padding-left: 8px; background: #f8faff;}
    .rawbox { font-size: 0.92em; color: #999; background: #f4f4f4; border-radius: 5px; padding: 6px; margin-top: 6px; margin-bottom: 6px; }
  </style>
</head>
<body>
  <h2>WestlandRAG Chat</h2>
  <div id="chatbox"></div>
  <input id="vraag" placeholder="Stel uw vraag..." autofocus>
  <button id="send">Verstuur</button>

  <script>
    const chatbox = document.getElementById('chatbox');
    const vraagInput = document.getElementById('vraag');
    const sendBtn = document.getElementById('send');

    function escapeHtml(unsafe) {
      if (!unsafe) return '';
      return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    function formatResultaatAntwoord(resultaat) {
      let html = '';

      // Hoofdantwoord/snippet
      if (resultaat.snippet) {
        html += `<div class="snippet-main">${escapeHtml(resultaat.snippet)}</div>`;
      }

      // Bijzinnen/waarschuwingen/extra
      if (Array.isArray(resultaat.extra) && resultaat.extra.length > 0) {
        html += resultaat.extra.map(
          z => `<div class="bijzin">${escapeHtml(z)}</div>`
        ).join('');
      }

      // Toelichting (indien aanwezig)
      if (resultaat.toelichting) {
        html += `<div class="toelichtingbox"><b>AI-uitleg:</b> ${escapeHtml(resultaat.toelichting)}</div>`;
      }

      // Bron
      if (resultaat.bron) {
        html += `<div class="bronnenbox"><b>Bron:</b> <a href="${escapeHtml(resultaat.bron)}" target="_blank">${escapeHtml(resultaat.bron)}</a></div>`;
      }

      // Optioneel: toon ook het rauwe antwoord (voor debugging/demonstratie)
      // if (resultaat.raw) {
      //   html += `<div class="rawbox"><b>Ruw AI-antwoord:</b> ${escapeHtml(resultaat.raw)}</div>`;
      // }

      return html;
    }

    function appendMessage(wie, text, isHtml=false) {
      if (wie === "AI") {
        chatbox.innerHTML += `<div class="antwoord"><b class="ai-label">AI:</b> ${isHtml ? text : escapeHtml(text)}</div>`;
      } else {
        chatbox.innerHTML += `<div><b class="user-label">Jij:</b> ${escapeHtml(text)}</div>`;
      }
      chatbox.scrollTop = chatbox.scrollHeight;
    }

    async function verstuurVraag() {
      const vraag = vraagInput.value.trim();
      if (!vraag) return;
      appendMessage('Jij', vraag);
      vraagInput.value = '';
      appendMessage('AI', '<em>Even denken...</em>', true);
      const response = await fetch('http://localhost:8000/chat', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({vraag: vraag})
      });
      const data = await response.json();

      // Vervang laatste AI-message door het echte antwoord
      chatbox.innerHTML = chatbox.innerHTML.replace('<div class="antwoord"><b class="ai-label">AI:</b> <em>Even denken...</em></div>', '');

      // Als backend JSON-structuur gebruikt (nieuw), anders fallback op oude veld 'antwoord'
      if (data.resultaat) {
        appendMessage('AI', formatResultaatAntwoord(data.resultaat), true);
      } else if (data.antwoord) {
        appendMessage('AI', escapeHtml(data.antwoord), true);
      } else {
        appendMessage('AI', '<em>Er is geen antwoord beschikbaar.</em>', true);
      }
    }

    sendBtn.onclick = verstuurVraag;
    vraagInput.addEventListener('keydown', e => { if (e.key === 'Enter') verstuurVraag(); });
  </script>
</body>
</html>
